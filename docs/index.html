<!DOCTYPE html>
<html lang="en">
<!--
    Show artifact details for a repository
-->
  <head>
    <meta charset="UTF-8" />
    <style>
      body {
        margin: 100px;
      }
      table {
        border-collapse: collapse;
        margin: 25px 0;
        font-size: 0.9em;
        font-family: sans-serif;
        min-width: 400px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
      }
      thead tr {
        background-color: #009879;
        color: #ffffff;
        text-align: left;
      }
      table th,
      table td {
        padding: 10px 5px;
      }
      table tbody tr {
        border-bottom: 1px solid #dddddd;
      }
      table tbody tr:nth-of-type(even) {
        background-color: #f3f3f3;
      }
      table tbody tr:last-of-type {
        border-bottom: 2px solid #009879;
      }
    </style>
  </head>

  <body>
    <h2>Artifacts in <span id="repo_name"></span></h2>
    <p>
    Click on the Run link to show the page which lists the artifact where it can be downloaded or deleted.
    </p>
    <p>The page listss artifacts for the current user and repo by default.
      The user and repo can be overridden by providing 'user' and 'repo' URL parameters.
      i.e. ?user={username}&repo={reponame}
    </p>
    <table>
        <thead>
            <tr>
            <td>Name (Download URL)</td>
            <td>Bytes</td>
            <td>Created</td>
            <td>Updated</td>
            <td>Expires</td>
            <td>Expired</td>
            <td>Run</td>
            </tr>
        </thead>
        <tbody id=container>
        </tbody>
    </table>
  </body>

<script>
async function getData(user, repo) {
  try {
    const response = await fetch(
      `https://api.github.com/repos/${user}/${repo}/actions/artifacts`,
      {
        method: 'GET',
      },
    );

    if (!response.ok) {
      throw new Error(`Error! status: ${response.status}`);
    }

    const data = await response.json();
    return data;
  } catch (error) {
    alert(error + ` for ${user}/${repo}`);
    return {artifacts: []};
  }
}

const params = new URL(document.location).searchParams;
const user = params.get('user') || window.location.hostname.replace(/\.github.*/,'');
const repo = params.get('repo') || window.location.pathname.split('/')[1];
const repo_name = document.getElementById('repo_name');
repo_name.innerHTML=`${user}/${repo}`;

getData(user, repo).then(data => {

  const parts = [];
  data.artifacts.forEach(artifact => {
    parts.push('<tr>');
    parts.push(`<td><a href="${artifact.archive_download_url}">${artifact.name}</a></td>`);
    parts.push(`<td>${artifact.size_in_bytes}</td>`);
    parts.push(`<td>${artifact.created_at}</td>`);
    parts.push(`<td>${artifact.updated_at}</td>`);
    parts.push(`<td>${artifact.expires_at}</td>`);
    parts.push(`<td>${artifact.expired}</td>`);
    const runurl = artifact.url.replace('api.','').
        replace('/repos','').replace(/artifacts\/.*/,`runs/${artifact.workflow_run.id}`);
    parts.push(`<td><a href="${runurl}">Run</a></td>`);
    parts.push('</tr>');
  });
  const container = document.getElementById('container');
  container.innerHTML = parts.join("\n");
});
</script>
</html>
